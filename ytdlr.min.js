(()=>{window.ytdlr=(()=>ytdlr());let util={base:"https://www.youtube.com",between:(e,t,a,i=0,n=0)=>{let r=e.indexOf(t),s=e.indexOf(a,r);return a||(s=e.length),e.substring(r+t.length+n,s+i)},text:e=>"string"==typeof e?e.replace(/\+/g," "):e.simpleText||e.runs.map(e=>e.text).join("")};async function ytdlr(){let e=window.location.href.match(/^(?:https?:\/\/)?(?:www\.)?youtu\.?be(?:\.com)?.*?(?:v|list)=(.*?)(?:&|$)|^(?:https?:\/\/)?(?:www\.)?youtu\.?be(?:\.com)?(?:(?!=).)*\/(.*)$/i);if(!e||!e[1])return;let t=e[1],a=await getPlayerData(),i=await getVideoData(t,a.sts);return formatResponse(i,decipherFormats([...Object.values(i.streamingData.formats),...Object.values(i.streamingData.adaptiveFormats)],a.fn))}async function getPlayerData(){let e=document.querySelector("head").innerHTML,t=JSON.parse(util.between(e,"window.ytplayer = {};ytcfg.set(","})",1)),a=await fetch(t.PLAYER_JS_URL,{base:util.base}).then(e=>e.text());return{sts:t.STS,fn:getCipherFunction(a)}}function getCipherFunction(str){let keys=['a=a.split("")',"};","var ","("],js=util.between(str,`${keys[0]};${keys[2]}`),top=util.between(js,keys[0],keys[1],1,-28),fn=keys[2]+util.between(top,keys[0],keys[3],10,1).split(".")[0],side=util.between(js,fn,keys[1],2,-fn.length);return eval(side+top)}async function getVideoData(e,t,a){let i=new URL("get_video_info",util.base),n={video_id:e,eurl:"https://youtube.googleapis.com/v/"+e,ps:"default",gl:"US",hl:"en",el:a?"detailpage":"embedded",sts:t};return Object.keys(n).forEach(e=>i.searchParams.append(e,n[e])),parseData(await fetch(i).then(e=>e.text())).player_response}function parseData(e){let t={},a="object"==typeof e?Object.entries(e):e.split("&").map(e=>e.split("="));for(let e=0;e<a.length;e++){let i=a[e][0],n=a[e][1];"player_response"===i&&(n=JSON.parse(decodeURIComponent(n))),"object"==typeof n&&(n=parseData(n)),t[i]=n}return t}function decipherFormats(e,t){e=Object.values(e);for(let a=0;a<e.length;a++){let i=e[a];if(i.mimeType&&(i.mimeType=i.mimeType.replace(/\+/g," ")),i.signatureCipher){let e=parseData(i.signatureCipher);delete i.signatureCipher,i.url=`${decodeURIComponent(e.url)}&${e.sp}=${t(decodeURIComponent(e.s))}`}}return e}function formatResponse(e,t){let a=e.videoDetails,i=e.microformat.playerMicroformatRenderer,n=i.ownerProfileUrl,r=/(?<=codecs=").*(?=")/;return{info:{id:a.videoId,type:i.isUnlisted?"unlisted":"public",title:util.text(i.title).replace(/\+/g," "),description:util.text(i.description).replace(/\+/g," "),thumbnails:Object.values(a.thumbnail.thumbnails),date:i.publishDate,duration:1e3*Number(a.lengthSeconds),views:Number(a.viewCount),author:{id:a.channelId,vanity:n.indexOf("/user/")>=0?util.between(n,"/user/"):null,title:a.author}},formats:t=t.map(e=>{let t=e.mimeType.split(";");return e.mime=t[0],e.codecs=t[1].match(r)[0].split(", "),e.size=Number(e.contentLength),e.duration=Number(e.approxDurationMs),e.audioSampleRate&&(e.samplerate=Number(e.audioSampleRate)),e.quality=e.qualityLabel||e.audioQuality,e.channels=e.audioChannels,e})}}})();